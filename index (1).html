<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DB Produktdaten Vergleichstool (Batch)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto; margin:0; background:#f6f8fb}
    header{background:#2c3e50;color:#fff;padding:20px}
    h1{margin:0;font-weight:600}
    main{max-width:1200px;margin:30px auto;padding:20px;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .row{display:flex;gap:20px;flex-wrap:wrap}
    .card{flex:1;min-width:320px;background:#fff;border:1px solid #eaeef3;border-radius:12px;padding:20px}
    .upload{border:2px dashed #9b59b6;border-radius:12px;padding:30px;text-align:center;cursor:pointer}
    .upload:hover{background:#fbf7ff}
    .btn{background:#2e7d32;color:#fff;border:none;border-radius:10px;padding:12px 18px;cursor:pointer;font-weight:600}
    .btn.secondary{background:#1565c0}
    .btn[disabled]{background:#bfc9d9;cursor:not-allowed}
    .muted{color:#667085;font-size:.95rem}
    .progress{display:none;margin-top:12px}
    .bar{height:10px;background:#eaeef3;border-radius:6px;overflow:hidden}
    .bar>div{width:0%;height:100%;background:#3498db;transition:width .3s}
    .status{margin-top:8px;font-size:.9rem;color:#555}
    .ok{background:#d5f4e6;padding:4px 8px;border-radius:6px;display:inline-block}
    .warn{background:#fff3cd;padding:4px 8px;border-radius:6px;display:inline-block}
  </style>
</head>
<body>
  <header>
    <h1>🚆 DB Produktdaten Vergleichstool</h1>
    <p class="muted">Upload → Verarbeiten (Scraping & Vergleich) → Download</p>
  </header>
  <main>
    <div class="row">
      <div class="card">
        <div id="drop" class="upload">
          <input id="file" type="file" accept=".xlsx,.xls" style="display:none"/>
          <p>📁 <strong>Excel-Datei hier ablegen</strong> oder klicken</p>
          <p class="muted">Header in Zeile 3, Daten ab Zeile 4. Spalten: Z, E, C, S, U, V, W, P, N</p>
        </div>
        <div style="margin-top:16px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <button id="process" class="btn" disabled>1) Verarbeiten</button>
          <button id="download" class="btn secondary" disabled>2) Herunterladen</button>
          <span id="filename" class="muted">Keine Datei gewählt</span>
        </div>
        <div class="progress" id="progress">
          <div class="bar"><div id="barfill"></div></div>
          <div class="status" id="status">Bitte warten – Web-Scraping läuft …</div>
        </div>
        <div style="margin-top:10px">
          <span class="ok">Grün</span> gleich (strikt) &nbsp;&nbsp;
          <span class="warn">Orange</span> fehlend / unklar &nbsp;&nbsp; 🔴 Rot = Abweichung
        </div>
      </div>
      <div class="card">
        <h3>Tipps zur Geschwindigkeit</h3>
        <ul>
          <li>Parallelisierung auf dem Server (Standard: 4 gleichzeitige Seiten)</li>
          <li>Blockierte Bilder/CSS/Fonts für schnellere Seitenaufrufe</li>
          <li>A2V-Dubletten werden per Cache nur einmal gescraped</li>
        </ul>
      </div>
    </div>
  </main>
  <script>
    const drop = document.getElementById('drop');
    const input = document.getElementById('file');
    const btnProcess = document.getElementById('process');
    const btnDownload = document.getElementById('download');
    const filename = document.getElementById('filename');
    const progress = document.getElementById('progress');
    const barfill = document.getElementById('barfill');
    const statusEl = document.getElementById('status');

    let file = null;
    let lastBlob = null;

    drop.addEventListener('click', ()=> input.click());
    drop.addEventListener('dragover', (e)=>{ e.preventDefault(); drop.style.background='#fbf7ff'; });
    drop.addEventListener('dragleave', ()=> drop.style.background='');
    drop.addEventListener('drop', (e)=>{
      e.preventDefault(); drop.style.background='';
      if (e.dataTransfer.files.length) setFile(e.dataTransfer.files[0]);
    });
    input.addEventListener('change', ()=> input.files.length && setFile(input.files[0]));

    function setFile(f){
      if(!/\.(xlsx|xls)$/i.test(f.name)){ alert('Bitte .xlsx oder .xls wählen'); return; }
      file = f; filename.textContent = `Gewählt: ${f.name} (${(f.size/1024/1024).toFixed(2)} MB)`;
      btnProcess.disabled = false; btnDownload.disabled = true; lastBlob = null;
    }

    btnProcess.addEventListener('click', async ()=>{
      if(!file) return;
      btnProcess.disabled = true;
      progress.style.display = 'block';
      barfill.style.width = '15%'; statusEl.textContent = 'Upload läuft …';

      const fd = new FormData();
      fd.append('file', file);

      try{
        const resp = await fetch('/api/process-excel', { method:'POST', body: fd });
        if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
        barfill.style.width = '70%'; statusEl.textContent = 'Verarbeitung abgeschlossen – Datei bereit zum Download';
        lastBlob = await resp.blob();
        btnDownload.disabled = false;
        barfill.style.width = '100%'; statusEl.textContent = 'Fertig ✅';
      }catch(e){
        alert('Fehler: ' + e.message);
        statusEl.textContent = 'Fehler – Details in Konsole';
        console.error(e);
      }finally{
        btnProcess.disabled = false;
      }
    });

    btnDownload.addEventListener('click', ()=>{
      if(!lastBlob){ alert('Bitte zuerst verarbeiten.'); return; }
      const url = URL.createObjectURL(lastBlob);
      const a = document.createElement('a');
      a.href = url; a.download = 'DB_Produktvergleich_verarbeitet.xlsx';
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=> URL.revokeObjectURL(url), 2000);
    });
  </script>
</body>
</html>